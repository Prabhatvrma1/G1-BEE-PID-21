<%- include('../partials/header') %>
<h3 class="mb-3">Applicants for <%= company.name %> - <%= company.role %></h3>
<% if (!applications || applications.length === 0) { %>
  <div class="alert alert-info">No applications yet for this company.</div>
<% } else { %>
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Student</th>
        <th>Email</th>
        <th>Location</th>
        <th>Status</th>
        <th>Applied On</th>
        <th>Resume</th>
        <th>Update Status</th>
      </tr>
    </thead>
    <tbody>
      <% applications.forEach(function(a) { %>
        <tr>
          <td><%= a.student ? a.student.fullName : 'Unknown' %></td>
          <td><%= a.student ? a.student.email : '-' %></td>
          <td><%= a.student && a.student.location ? a.student.location : '-' %></td>
          <td class="text-capitalize"><%= a.status %></td>
          <td><%= new Date(a.createdAt).toLocaleDateString() %></td>
          <td>
            <% if (a.student && resumeByStudentId && resumeByStudentId[a.student._id.toString()]) { %>
              <% const r = resumeByStudentId[a.student._id.toString()]; %>
              <p class="mb-1">
                <strong><%= r.fileOriginalName || 'Resume file' %></strong>
              </p>
              <% if (r.uploadedAt) { %>
                <p class="mb-1 text-muted"><small>Uploaded on <%= new Date(r.uploadedAt).toLocaleString() %></small></p>
              <% } %>
              <% if (r.fileUrl) { %>
                <a href="<%= r.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-primary">View / download</a>
              <% } else { %>
                <span class="text-muted"><small>No file link available</small></span>
              <% } %>
            <% } else if (a.resumeSnapshot) { %>
              <details>
                <summary class="text-muted" style="cursor:pointer;"><small>View resume snapshot</small></summary>
                <pre class="mt-2 small" style="white-space: pre-wrap;"><%= a.resumeSnapshot %></pre>
              </details>
            <% } else { %>
              <span class="text-muted"><small>No resume available</small></span>
            <% } %>
          </td>
          <td>
            <form method="post" action="/admin/applications/<%= a._id %>/status" class="d-flex gap-2 align-items-center">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <select name="status" class="form-select form-select-sm" style="max-width: 140px;">
                <option value="applied" <%= a.status === 'applied' ? 'selected' : '' %>>Applied</option>
                <option value="shortlisted" <%= a.status === 'shortlisted' ? 'selected' : '' %>>Shortlisted</option>
                <option value="rejected" <%= a.status === 'rejected' ? 'selected' : '' %>>Rejected</option>
                <option value="selected" <%= a.status === 'selected' ? 'selected' : '' %>>Selected</option>
              </select>
              <button class="btn btn-sm btn-primary">Save</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } %>
<%- include('../partials/footer') %>
